    // Calendario unico ottimizzato per prestazioni
    let bookingRules = {
        blockedRanges: [],
        minStay: 1,
        maxStay: 30,
        windowStart: null,
        windowEnd: null
    };
    let checkinBlockedDatesSet = new Set();
    let checkoutBlockedDatesSet = new Set();
    let checkinBlockedWeekdays = new Set();
    let checkoutBlockedWeekdays = new Set();
    let turnoverDaysSet = new Set();
    let mainCalendar = null;
    const currencyFormatter = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });

    function formatDate(date, format) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');

        if (format === 'Y-m-d') {
            return `${year}-${month}-${day}`;
        }
        return `${day}/${month}/${year}`;
    }

    function hydrateBookingRules(payload) {
        const blockedRanges = Array.isArray(payload.blocked_ranges) ? payload.blocked_ranges : [];
        bookingRules.blockedRanges = blockedRanges.filter(range => range && range.from && range.to);

        const metadata = payload.metadata || {};
        bookingRules.minStay = metadata.min_stay || 1;
        bookingRules.maxStay = metadata.max_stay || 30;
        bookingRules.windowStart = metadata.start || null;
        bookingRules.windowEnd = metadata.end || null;

        const checkinBlock = payload.checkin_block || {};
        const checkoutBlock = payload.checkout_block || {};

        checkinBlockedDatesSet = new Set(checkinBlock.dates || []);
        checkoutBlockedDatesSet = new Set(checkoutBlock.dates || []);
        checkinBlockedWeekdays = new Set((checkinBlock.weekdays || []).map(Number));
        checkoutBlockedWeekdays = new Set((checkoutBlock.weekdays || []).map(Number));
        turnoverDaysSet = new Set(payload.turnover_days || []);
    }

    function buildDisabledDates() {
        return bookingRules.blockedRanges.map(range => ({
            from: range.from,
            to: range.to,
        }));
    }

    const calendarLoadStart = performance.now();
    console.debug('Calendario: avvio caricamento');

    fetch(`{% url 'listings:unavailable_dates' listing.slug %}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Risposta non valida dal server');
            }
            return response.json();
        })
        .then(data => {
            hydrateBookingRules(data);
            initializeUnifiedCalendar();
            const loadTime = (performance.now() - calendarLoadStart).toFixed(2);
            console.debug(`Calendario: dati caricati in ${loadTime}ms`);
        })
        .catch(error => {
            console.error('Calendario: errore durante il caricamento', error);
            initializeUnifiedCalendar();
            showAvailabilityMessage('Impossibile caricare le disponibilita aggiornate. Riprova piu tardi.', 'warning');
        });

    function initializeUnifiedCalendar() {
        const calendarInput = document.getElementById('calendar');
        const checkInInput = document.getElementById('check-in');
        const checkOutInput = document.getElementById('check-out');

        if (!calendarInput) {
            return;
        }

        if (mainCalendar) {
            mainCalendar.destroy();
        }

        const disableConfig = buildDisabledDates();

        mainCalendar = flatpickr('#calendar', {
            mode: 'range',
            dateFormat: 'Y-m-d',
            locale: 'it',
            minDate: bookingRules.windowStart || 'today',
            maxDate: bookingRules.windowEnd || new Date().fp_incr(365),
            showMonths: 2,
            disable: disableConfig,
            onDayCreate: function(_dObj, _dStr, fp, dayElem) {
                const dateStr = fp.formatDate(dayElem.dateObj, 'Y-m-d');
                const weekday = dayElem.dateObj.getDay();
                const hints = [];

        ... (truncated for brevity) ...
