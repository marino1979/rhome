{% extends "base.html" %}
{% load static %}

{% block title %}{{ listing.title }} - Rhome{% endblock %}

{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Splide CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
<!-- GLightbox CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<!-- Calendar Styles -->
<link rel="stylesheet" href="{% static 'css/calendar-styles.css' %}">

<style>
  /* Stili per il calendario migliorato */
  .calendar-container {
    position: relative;
  }
  
  .calendar-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 8px;
  }
  
  .calendar-input {
    background-color: white;
    border: 2px solid #e5e7eb;
    transition: all 0.2s ease;
  }
  
  .calendar-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .price-breakdown {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .availability-message {
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .availability-success {
    background-color: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  
  .availability-error {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }
  
  .availability-warning {
    background-color: #fefce8;
    color: #ca8a04;
    border: 1px solid #fde68a;
  }
  
  .availability-info {
    background-color: #eff6ff;
    color: #2563eb;
    border: 1px solid #bfdbfe;
  }
  
  .booking-button {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    transition: all 0.2s ease;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .booking-button:hover:not(:disabled) {
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
  
  .booking-button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .listing-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .listing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
  
  .amenity-tag {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    margin: 0.125rem;
  }
  
  .amenity-tag::before {
    content: '✓';
    margin-right: 0.25rem;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Dati nascosti per JavaScript -->
    <div id="listing-data" 
         data-listing-id="{{ listing.id }}" 
         data-listing-slug="{{ listing.slug }}"
         data-min-stay="{{ listing.min_stay|default:1 }}"
         data-max-stay="{{ listing.max_stay|default:30 }}"
         data-gap-days="{{ listing.gap_between_bookings|default:0 }}"
         data-base-price="{{ listing.base_price }}"
         data-max-guests="{{ listing.max_guests }}"
         style="display: none;">
    </div>
    
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ listing.title }}</h1>
        <div class="flex flex-wrap items-center text-gray-600 gap-4">
            <span class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                {{ listing.address }}
            </span>
            <span class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                </svg>
                {{ listing.max_guests }} ospiti
            </span>
            <span class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm8 0a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                </svg>
                {{ listing.bedrooms }} camere
            </span>
            <span class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                </svg>
                {{ listing.bathrooms }} bagni
            </span>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Contenuto principale -->
        <div class="lg:col-span-2">
            <!-- Galleria immagini -->
            <div class="mb-8">
                <div id="main-gallery" class="splide">
                    <div class="splide__track">
                        <ul class="splide__list">
                            {% for image in listing.images.all %}
                            <li class="splide__slide">
                                <img src="{{ image.image.url }}" 
                                     alt="{{ image.caption|default:listing.title }}"
                                     class="w-full h-80 object-cover rounded-lg cursor-pointer"
                                     data-glightbox="gallery">
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Descrizione -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Descrizione</h2>
                <div class="prose max-w-none text-gray-700">
                    {{ listing.description|linebreaks }}
                </div>
            </div>
            
            <!-- Servizi -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Servizi Inclusi</h2>
                <div class="flex flex-wrap">
                    {% for amenity in listing.amenities.all %}
                    <span class="amenity-tag">{{ amenity.name }}</span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Regole -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Regole della Casa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-900 mb-2">Check-in/Check-out</h3>
                        <p class="text-sm text-gray-600">Check-in: {{ listing.checkin_from|default:"15:00" }}</p>
                        <p class="text-sm text-gray-600">Check-out: {{ listing.checkout_time|default:"11:00" }}</p>
                    </div>
                    {% if listing.gap_between_bookings %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-900 mb-2">Gap tra prenotazioni</h3>
                        <p class="text-sm text-gray-600">{{ listing.gap_between_bookings }} giorno/i</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar prenotazione -->
        <div class="lg:col-span-1">
            <div class="listing-card sticky top-4">
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="text-4xl font-bold text-gray-900">
                            €{{ listing.base_price|floatformat:0 }}
                        </div>
                        <div class="text-gray-600">per notte</div>
                    </div>
                    
                    <!-- Form prenotazione -->
                    <form id="booking-form" class="space-y-4">
                        {% csrf_token %}
                        
                        <!-- Calendario -->
                        <div class="calendar-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Seleziona date
                            </label>
                            <input type="text" 
                                   id="calendar" 
                                   class="calendar-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Seleziona date di check-in e check-out"
                                   readonly>
                            
                            <!-- Loading indicator -->
                            <div id="calendar-loading" class="calendar-loading" style="display: none;">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                                    <div class="text-sm text-gray-600">Caricamento calendario...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input nascosti per check-in e check-out -->
                        <input type="hidden" id="check-in" name="check_in">
                        <input type="hidden" id="check-out" name="check_out">
                        
                        <!-- Numero ospiti -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ospiti
                            </label>
                            <select id="guests" name="guests" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for i in "123456789"|make_list %}
                                {% if forloop.counter <= listing.max_guests %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }} {% if forloop.counter == "1" %}ospite{% else %}ospiti{% endif %}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Messaggio disponibilità -->
                        <div id="availability-message" class="hidden">
                            <div id="availability-text" class="text-sm"></div>
                        </div>
                        
                        <!-- Breakdown prezzo -->
                        <div id="price-breakdown" class="hidden">
                            <div class="price-breakdown">
                                <h4 class="font-semibold text-gray-900 mb-3">Riepilogo Prezzo</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Prezzo base</span>
                                        <span id="base-price">€0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Pulizie</span>
                                        <span id="cleaning-fee">€0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ospiti extra</span>
                                        <span id="extra-guest-fee">€0</span>
                                    </div>
                                    <div class="flex justify-between font-semibold border-t pt-2 text-base">
                                        <span>Totale</span>
                                        <span id="total-price">€0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pulsante prenotazione -->
                        <button type="submit" 
                                class="booking-button w-full py-4 px-6 rounded-lg text-white font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            Prenota ora
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Dipendenze esterne -->
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>

<!-- Moduli core -->
<script src="{% static 'js/config.js' %}"></script>
<script src="{% static 'js/utils/DateUtils.js' %}"></script>
<script src="{% static 'js/utils/ErrorHandler.js' %}"></script>
<script src="{% static 'js/modules/StateManager.js' %}"></script>
<script src="{% static 'js/modules/APIClient.js' %}"></script>
<script src="{% static 'js/modules/CSSManager.js' %}"></script>
<script src="{% static 'js/modules/RuleManager.js' %}"></script>
<script src="{% static 'js/modules/SimpleCalendarManager.js' %}"></script>
<script src="{% static 'js/components/UIComponents.js' %}"></script>

<!-- Entry point semplificato -->
<script src="{% static 'js/simple-listing-detail.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inizializza galleria immagini
    if (document.querySelector('#main-gallery')) {
        new Splide('#main-gallery', {
            type: 'slide',
            perPage: 1,
            perMove: 1,
            gap: '1rem',
            pagination: false,
            arrows: true,
            autoplay: false,
            interval: 5000,
        }).mount();
    }
    
    // Inizializza lightbox
    const lightbox = GLightbox({
        touchNavigation: true,
        loop: true,
        autoplayVideos: true,
        selector: '[data-glightbox]'
    });
    
    // Gestione form prenotazione migliorata
    const bookingForm = document.getElementById('booking-form');
    const bookingButton = bookingForm.querySelector('button[type="submit"]');
    
    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const checkIn = document.getElementById('check-in').value;
            const checkOut = document.getElementById('check-out').value;
            const guests = document.getElementById('guests').value;
            
            if (!checkIn || !checkOut) {
                UIComponents.createNotification('Seleziona le date di check-in e check-out', 'warning');
                return;
            }
            
            // Disabilita il pulsante durante il redirect
            bookingButton.disabled = true;
            bookingButton.textContent = 'Reindirizzamento...';
            
            // Redirect al sistema di prenotazione esterno
            const url = new URL('https://maggimilano-new.kross.travel/book/step1');
            url.searchParams.set('from', checkIn);
            url.searchParams.set('to', checkOut);
            url.searchParams.set('guests', guests);
            url.searchParams.set('adults', guests);
            url.searchParams.set('children', '0');
            url.searchParams.set('rooms', '1');
            
            window.location.href = url.toString();
        });
    }
    
    // Gestione cambio ospiti
    const guestsSelect = document.getElementById('guests');
    if (guestsSelect) {
        guestsSelect.addEventListener('change', function() {
            // Ricalcola il prezzo se ci sono date selezionate
            const checkIn = document.getElementById('check-in').value;
            const checkOut = document.getElementById('check-out').value;
            
            if (checkIn && checkOut && window.simpleCalendarManager) {
                const selectedDates = window.simpleCalendarManager.stateManager.getState('singleCalendar.selectedDates');
                if (selectedDates && selectedDates.length === 2) {
                    window.simpleCalendarManager.calculatePrice(selectedDates[0], selectedDates[1]);
                }
            }
        });
    }
});
</script>
{% endblock %}
